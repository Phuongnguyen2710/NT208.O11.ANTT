@model TicketLand_project.ViewModels.SeatViewModel
@{
    ViewData["Title"] = "Booking";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@{
    if (ViewBag.ShowSuccessModal != null && (bool)ViewBag.ShowSuccessModal)
    {
        <script>
            $(document).ready(function () {
                showSuccessModal();
            });
        </script>
    }
}

<link href="~/Areas/Assets/css/Seat.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<style>
    .seat {
        display: inline-block;
        margin: 5px;
    }

    .selected {
        background-color: #28a745;
        color: #ffffff;
        background-image: none;
    }

    #infoScreen {
        background-color: #f0f0f0;
        padding: 10px;
        margin-top: 20px;
    }
</style>

<div class="center">
    <div id="infoScreen">
        <!-- Màn hình ở đầu trang -->
        <h4>Thông tin suất chiếu</h4>
        <p>Ngày chiếu: @Model.Schedule.show_date.ToShortDateString()</p>
        <p>Giờ chiếu: @Model.Schedule.time_start.ToString("hh\\:mm")</p>
        <p id="selectedSeatsInfo">Ghế đã chọn: </p>
    </div>
    <div class="tickets">

        <div class="ticket-selector">
            <div class="head">
                <div class="title">SƠ ĐỒ CHỖ NGỒI</div>
            </div>


            <br />

            <!--Màn hình-->
            <div class="screen"></div>

            <form id="seatForm">
                <!-- Tạo 50 ghế bằng check box -->
                <div>
                    @for (var row = 1; row <= 5; row++)
                    {
                        for (var col = 1; col <= 10; col++)
                        {
                            var seatId = String.Format("{0}{1}", (char)(row + 64), col);

                            var seat = Model.Seats.FirstOrDefault(s => s.row == Convert.ToString((char)(row + 64)) && s.number == col);
                            var isSelected = Model.SelectedSeats != null && Model.SelectedSeats.Contains(seatId);
                            if (seat != null)
                            {
                                var disabled = (bool)seat.seats_status || isSelected;
                                <label class="seat">
                                    <input type="checkbox" name="selectedSeats" value="@seatId" onclick="updateSeatStatus(this)" />
                                    <span class="seat-label">@seatId</span>
                                </label>

                            }
                            else
                            {
                                <span class="hidden-seat" style="visibility: hidden">
                                    <!-- Đối với các ghế không có trong bảng -->
                                    <label class="seat">
                                        <input type="checkbox" name="selectedSeats" value="@seatId" onclick="updateSeatStatus(this)" disabled />
                                        <span class="seat-label">@seatId</span>
                                    </label>
                                </span>
                            }
                        }
                        <br />
                    }
                </div>

                <!-- Nút để xác nhận việc chọn ghế -->
                <button type="button" onclick="submitForm()">Submit</button>
            </form>
            <!-- Modal -->
            <div class="modal" id="confirmModal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Booking</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="submitBk" method="post" action="@Url.Action("ConfirmBooking", "Home")">
                                <p>Are you sure you want to confirm the booking?</p>
                                <input type="hidden" name="scheduleId" value="@Model.Schedule.schedule_id" />
                                <input type="hidden" id="selectedSeatsInput" name="selectedSeats" />

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary" onclick="confirmBooking()">Confirm</button>
                                </div>
                            </form>

                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal thông báo -->
            <div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="successModalLabel">Booking Successful</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            Your booking has been successfully placed.
                        </div>
                    </div>
                </div>
            </div>

            <script>
                $(document).ready(function () {
                    // Sự kiện change để theo dõi sự thay đổi trạng thái của checkbox
                    $('input[name="selectedSeats"]').change(function () {
                        // Thêm hoặc xóa lớp 'selected' tùy thuộc vào trạng thái của checkbox
                        $(this).parent().toggleClass('selected', this.checked);
                    });
                });
                var selectedSeats = [];
                function updateSeatStatus(checkbox) {
                    /* var seatId = $(checkbox).val();

                     // Kiểm tra xem ghế đã được chọn hay chưa
                     var isSelected = selectedSeats.includes(seatId);

                     if (!isSelected) {
                         // Nếu ghế chưa được chọn, thêm vào danh sách
                         selectedSeats.push(seatId);
                     } else {
                         // Nếu ghế đã được chọn, loại bỏ khỏi danh sách
                         var index = selectedSeats.indexOf(seatId);
                         if (index !== -1) {
                             selectedSeats.splice(index, 1);
                         }
                     }
                     // Cập nhật thông tin ghế đã chọn
                     updateSelectedSeatsInfo();*/
                    var selectedSeats = $('input[name="selectedSeats"]:checked').map(function () {
                        return this.value;
                    }).get();
                    // Cập nhật giá trị của input selectedSeats
                    $('#selectedSeatsInput').val(selectedSeats.join(','));
                    updateSelectedSeatsInfo()
                }

                function updateSelectedSeatsInfo() {
                    var selectedSeatss = Array.from(document.querySelectorAll('input[name="selectedSeats"]:checked')).map(function (checkbox) {
                        return checkbox.value;
                    });

                    // Hiển thị thông tin ghế đã chọn
                    document.getElementById('selectedSeatsInfo').textContent = 'Ghế đã chọn: ' + selectedSeats.join(', ');
                }
                function submitForm() {
                    // Hiển thị modal khi bấm nút "Submit"

                    $('#confirmModal').modal('show');
                }
                function confirmBooking() {
                    // Gọi hàm xác nhận khi người dùng bấm nút "Confirm"
                    // Thực hiện các logic cần thiết, ví dụ: gọi đến action ConfirmBooking
                    $('#submitBk').submit();
                }


            </script>
        </div>
    </div>


</div>
<script>
    function showSuccessModal() {
        // Hiển thị modal
        $('#successModal').modal('show');

        // Đếm ngược 3 giây
        var countDown = 3;
        var countDownInterval = setInterval(function () {
            countDown--;

            // Hiển thị thời gian đếm ngược
            $('#countdown').text(countDown);

            // Kiểm tra nếu đã hết thời gian đếm ngược
            if (countDown <= 0) {
                // Đóng modal và dừng đếm ngược
                $('#successModal').modal('hide');
                clearInterval(countDownInterval);
            }
        }, 1000);
    }
</script>






